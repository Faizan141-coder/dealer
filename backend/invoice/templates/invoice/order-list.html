{#{% extends 'invoice/base.html' %}#}
{##}
{#{% block content %}#}
{#    <!-- Layout container -->#}
{#        <div class="layout-page">#}
{#          <!-- Navbar -->#}
{##}
{#          {% include 'userauth/logout_layout.html' %}#}
{##}
{#          <!-- / Navbar -->#}
{##}
{#          <!-- Content wrapper -->#}
{#          <div class="content-wrapper">#}
{#            <div class="container-xxl flex-grow-1 container-p-y">#}
{#              <!-- Order List Table -->#}
{#              <div class="card">#}
{#                <div class="card-datatable table-responsive">#}
{#                  <table class="datatables-order table border-top">#}
{#                    <thead>#}
{#                      <tr>#}
{#                        <th></th>#}
{#                        <th></th>#}
{#                        <th>order</th>#}
{#                        <th>date</th>#}
{#                        <th>customers</th>#}
{#                        <th>payment</th>#}
{#                        <th>status</th>#}
{#                        <th>method</th>#}
{#                        <th>actions</th>#}
{#                      </tr>#}
{#                    </thead>#}
{#                  </table>#}
{#                </div>#}
{#              </div>#}
{#            </div>#}
{##}
{#            <div class="content-backdrop fade"></div>#}
{#          </div>#}
{#          <!-- Content wrapper -->#}
{#        </div>#}
{#        <!-- / Layout page -->#}
{#{% endblock %}#}
{##}


{% extends 'invoice/base.html' %}

{% block content %}
    <!-- Layout container -->
    <div class="layout-page">
        <!-- Navbar -->
        {% include 'userauth/logout_layout.html' %}
        <!-- / Navbar -->

        <!-- Content wrapper -->
        <div class="content-wrapper">
            <div class="container-xxl flex-grow-1 container-p-y">
                <!-- Order List Table -->
                <div class="card">
                    <div class="card-datatable table-responsive">
                        <table class="datatables-order table border-top">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th>Order</th>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Payment</th>
                                    <th>Status</th>
                                    <th>Method</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
{#                            <tbody id="order-list">#}
{#                                {% for order in orders %}#}
{#                                    <tr>#}
{#                                        <td></td>#}
{#                                        <td></td>#}
{#                                        <td>{{ order.order_number }}</td>#}
{#                                        <td>{{ order.created_at }}</td>#}
{#                                        <td>{{ order.user.username }}</td>#}
{#                                        <td>Payment Info</td>#}
{#                                        <td>Status Info</td>#}
{#                                        <td>Method Info</td>#}
{#                                        <td>#}
{#                                            <button class="btn btn-primary">View</button>#}
{#                                        </td>#}
{#                                    </tr>#}
{#                                {% endfor %}#}
{#                            </tbody>#}


                            <tbody id="order-list">
    {% for order in orders %}
        <tr class="order-link" data-order-id="{{ order.id }}">
            <td></td>
            <td></td>
            <td>{{ order.order_number }}</td>
            <td>{{ order.created_at|date:"M d, Y" }}</td>
            <td>{{ order.user.username }}</td>
            <td>Payment Info</td>
            <td>{{ order.status }}</td>
            <td>Method Info</td>
            <td>
                <a href="{% url 'invoice:order-details' order.id %}" class="btn btn-primary">View</a>
                <button class="btn btn-secondary" data-bs-toggle="offcanvas" data-bs-target="#sendSMSOffcanvas">
                    Send SMS
                </button>
            </td>
        </tr>
    {% endfor %}
</tbody>

                        </table>
                    </div>
                </div>

            <!-- Send SMS Sidebar -->
            <div class="offcanvas offcanvas-end" id="sendSMSOffcanvas" aria-hidden="true">
        <div class="offcanvas-header mb-6 border-bottom">
            <h5 class="offcanvas-title">Send SMS</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body pt-0 flex-grow-1">
            <form id="sendSMSForm">
                <div class="mb-6">
                    <label for="sms-to" class="form-label">To</label>
                    <input type="text" class="form-control" id="sms-to" name="user-phone" readonly />
                </div>
                <div class="mb-6">
                    <label for="load-select" class="form-label">Select Load</label>
                    <select class="form-select" id="load-select" onchange="updateSMSContent()"></select>
                </div>
                <div class="mb-6">
                    <label for="sms-message" class="form-label">Message</label>
                    <textarea class="form-control" name="sms-message" id="sms-message" cols="3" rows="8" style="text-align: left; padding-left: 10px;"></textarea>
                </div>
                <div id="smsStatus" class="mb-3" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Sending...</span>
                    </div>
                    <span class="ms-2">Sending...</span>
                </div>
                <div id="smsSuccess" class="alert alert-success mb-3" style="display: none;">
                    SMS sent successfully!
                </div>
                <div class="mb-6 d-flex flex-wrap">
                    <button type="button" id="sendSMSButton" class="btn btn-primary me-4" onclick="sendSMS()">Send SMS</button>
                    <button type="button" class="btn btn-label-secondary" data-bs-dismiss="offcanvas">Cancel</button>
                </div>
            </form>
        </div>
    </div>
            <!-- /Send SMS Sidebar -->


            </div>
            <div class="content-backdrop fade"></div>
        </div>
        <!-- Content wrapper -->
    </div>
    <!-- / Layout page -->

    <script>
    let orderData = null;

    function populateSMSContent(orderId) {
        fetch(`/invoice/order/${orderId}/load-info/`)
            .then(response => response.json())
            .then(data => {
                orderData = data;
                document.getElementById('sms-to').value = data.customer_phone;

                const loadSelect = document.getElementById('load-select');
                loadSelect.innerHTML = '';
                data.loads.forEach((load, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `Load ${index + 1} - ${load.date} ${load.time}`;
                    loadSelect.appendChild(option);
                });

                updateSMSContent();
            })
            .catch(error => console.error('Error:', error));
    }

    function updateSMSContent() {
        if (!orderData) return;

        const loadIndex = document.getElementById('load-select').value;
        const load = orderData.loads[loadIndex];

        const smsContent = `
ðŸ”·Pickup: SESCO Terminals
ðŸ”·Delivery Address: ${load.address}
ðŸ”·Loading PIN:
ðŸ”·Time of Delivery: ${load.date} ${load.time}
        `;

        document.getElementById('sms-message').value = smsContent.trim();
    }

    document.querySelectorAll('.order-link').forEach(link => {
        link.addEventListener('click', function() {
            const orderId = this.getAttribute('data-order-id');
            populateSMSContent(orderId);
        });
    });

    function sendSMS() {
        const sendButton = document.getElementById('sendSMSButton');
        const smsStatus = document.getElementById('smsStatus');
        const smsSuccess = document.getElementById('smsSuccess');

        sendButton.disabled = true;
        smsStatus.style.display = 'block';
        smsSuccess.style.display = 'none';

        const message = document.getElementById('sms-message').value;
        const orderId = document.querySelector('.order-link[data-order-id]').getAttribute('data-order-id');

        fetch(`/invoice/order/${orderId}/send-sms-message/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                message: message,
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                smsStatus.style.display = 'none';
                smsSuccess.style.display = 'block';
                setTimeout(() => {
                    var offcanvasElement = document.getElementById('sendSMSOffcanvas');
                    var offcanvas = bootstrap.Offcanvas.getInstance(offcanvasElement);
                    offcanvas.hide();
                }, 2000);
            } else {
                console.log("Error", data);
                alert('Failed to send SMS: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while sending the SMS.');
        })
        .finally(() => {
            sendButton.disabled = false;
            smsStatus.style.display = 'none';
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>

{% endblock %}




